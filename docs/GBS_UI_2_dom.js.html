<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: GBS_UI_2_dom.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: GBS_UI_2_dom.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* GBS_UI_2_dom.js */

/**
	@file Define major UI Widgets.
	@author BIOWP
*/

function createMinimizeButton(parentName){
	const pName = parentName;
	var button = createElement("button", '&lt;i class="fa fa-minus" aria-hidden="true">&lt;/i>',{
		class: "button-icon", title: "Minimize"
	});
	button.onclick = function(){
		$($$$(this).parent(pName).node.children[1]).slideToggle('fast');
	}
	return button;
}


function createCopyPokemonButton(){
	var copyPokemonButton = createElement('button','&lt;i class="fa fa-files-o" aria-hidden="true">&lt;/i>', {
		class: "button-icon", title: "Copy"
	});
	copyPokemonButton.onclick = function(){
		LocalData.PokemonClipboard = read($$$(this).parent("pokemon").node);
		saveLocalData();
	}
	return copyPokemonButton;
}


function createPastePokemonButton(){
	var pastePokemonButton = createElement('button','&lt;i class="fa fa-clipboard" aria-hidden="true">&lt;/i>', {
		class: "button-icon", title: "Paste"
	});
	pastePokemonButton.onclick = function(){
		var pokemonNode = $$$(this).parent("pokemon").node;
		write(pokemonNode, LocalData.PokemonClipboard || {});
		formatting(pokemonNode);
	}
	return pastePokemonButton;
}


function createRemovePokemonButton(){
	var removePokemonButton = createElement('button', '&lt;i class="fa fa-times" aria-hidden="true">&lt;/i>', {
		class: "button-icon", title: "Remove"
	});
	removePokemonButton.onclick = function(){
		var pokemonNode = $$$(this).parent("pokemon").node;
		if (pokemonNode.parentNode.children.length > 1){
			pokemonNode.parentNode.removeChild(pokemonNode);
		}else{
			sendFeedbackDialog("Cannot remove the only Pokemon of the party.");
		}
		relabel();
	}
	return removePokemonButton;
}


function createPokemonRoleInput(){
	var roleInput = createElement("select", "", {name: "pokemon-role"});
	roleInput.appendChild(createElement('option', 'Attacker', {value: "a"}));
	roleInput.appendChild(createElement('option', 'Attacker Basic', {value: "a_basic"}));
	roleInput.appendChild(createElement('option', 'Gym Defender', {value: "gd"}));
	roleInput.appendChild(createElement('option', 'Gym Defender Basic', {value: "gd_basic"}));
	roleInput.appendChild(createElement('option', 'Raid Boss', {value: "rb"}));
	roleInput.appendChild(createElement('option', 'Raid Boss Immortal', {value: "RB"}));
	roleInput.onchange = function(){
		var pokemonNode = $$$(this).parent("pokemon").node;
		for (var i = 0; i &lt; pokemonNode.children[1].children.length; i++){
			var child = pokemonNode.children[1].children[i];
			if (child.hasAttribute("for_roles")){
				let roles = child.getAttribute("for_roles").split(";");
				if (roles.includes(this.value)){
					child.removeAttribute("hidden");
				}else{
					child.setAttribute("hidden", true);
				}
			}
		}
		var strategyNode = $$$(pokemonNode).child("pokemon-strategy").node;
		if (this.value == "a" || this.value == "a_basic"){
			if (strategyNode.value == "strat0")
				strategyNode.value = "strat1";
		}else{
			strategyNode.value = "strat0";
		}
	}
	roleInput.comply = function(kwargs){
		this.disabled = false;
		if (kwargs.battleMode == "raid" || kwargs.battleMode == "gym"){
			if ($$$(this).parent("player").child("player-team").val() == "1"){
				if (kwargs.battleMode == "raid"){
					if (this.value.toLowerCase() != "rb"){
						this.value = "rb";
					}
				}else{
					this.value = "gd";
				}
				this.onchange();
				//this.disabled = true;
			}
		}else if (kwargs.battleMode == "pvp"){
			if (this.value != "a" &amp;&amp; this.value != "a_basic"){
				this.value = "a";
				this.onchange();
			}
		}
	}
	return roleInput;
}


function createPokemonCopiesInput(){
	var copiesInput = createElement('input', '', {
		type: 'number', placeholder: 'Copies', title: "Number of copies",
		min: 1, max: 6, value: 1, name: "pokemon-copies"
	});
	copiesInput.onchange = function(){
		var pokemonCount = countPokemonFromParty($$$(this).parent("party").node);
		if (pokemonCount > MAX_NUM_POKEMON_PER_PARTY){
			this.value -= pokemonCount - MAX_NUM_POKEMON_PER_PARTY;
		}
		if (this.value &lt; 1)
			this.value = 1;
	}
	copiesInput.comply = function(kwargs){
		this.disabled = false;
		if (kwargs.battleMode == "raid" || kwargs.battleMode == "gym"){
			if ($$$(this).parent("player").child("player-team").val() == "1"){
				this.value = 1;
				this.disabled = true;
			}
		}
	}
	return copiesInput;
}


function createPokemonRaidTierInput(){
	var raidTierInput = createElement("select", "", {
		name: "pokemon-raidTier"
	});
	for (let raidTier of Data.RaidTierSettings){
		raidTierInput.appendChild(createElement('option', raidTier.label, {value: raidTier.name}));
	}
	raidTierInput.onchange = function(){
		this.comply({battleMode: $("#battleMode").val()});
	}
	raidTierInput.comply = function(kwargs){
		if (kwargs.battleMode == "raid"){
			if ($$$(this).parent("player").child("player-team").val() == "1"){
				var timelimitInput = document.getElementById("timelimit");
				if (parseInt(this.value) &lt;= 4){
					timelimitInput.value = Data.BattleSettings.timelimitRaidMs;
				}else{
					timelimitInput.value = Data.BattleSettings.timelimitLegendaryRaidMs;
				}
			}
		}
	}
	return raidTierInput;
}


function createPokemonStrategyInput(){
	var strategyInput = createElement('select', '', {name: "pokemon-strategy"});
	strategyInput.appendChild(createElement('option', 'No Dodge', {value: "strat1"}));
	strategyInput.appendChild(createElement('option', 'No Dodge Burst', {value: "strat4"}));
	strategyInput.appendChild(createElement('option', 'Dodge Charged', {value: "strat2"}));
	strategyInput.appendChild(createElement('option', 'Dodge All', {value: "strat3"}));
	strategyInput.appendChild(createElement('option', 'Defender AI', {value: "strat0"}));
	strategyInput.appendChild(createElement('option', 'PvP Smart', {value: "strat5"}));
	strategyInput.comply = function(kwargs){
		this.disabled = false;
		if (kwargs.battleMode == "raid" || kwargs.battleMode == "gym"){
			if ($$$(this).parent("player").child("player-team").val() == "1"){
				this.value = "strat0";
				this.disabled = true;
			}
		}else if (kwargs.battleMode == "pvp"){
			this.value = "strat5";
			var strat2 = $$$(this).parent("pokemon").child("pokemon-strategy2").node;
			this.setAttribute("hidden", true);
			strat2.removeAttribute("hidden");
		}
	}
	return strategyInput;
}


function createPokemonProtectStrategyInput(){
	var strategyInput = createElement('input', '0,0', {name: "pokemon-strategy2", placeholder: "Protect Shield Strategy", 
		title: "{n_1,n_2}: tank n_i attacks then use the i-th Shield. * = infinity"
	});
	strategyInput.comply = function(kwargs){
		if (kwargs.battleMode != "pvp"){
			var strat1 = $$$(this).parent("pokemon").child("pokemon-strategy").node;
			this.setAttribute("hidden", true);
			strat1.removeAttribute("hidden");
		}
	}
	return strategyInput;
}

function createPartyNameInput(){
	var partyNameInput = createElement('input', '', {
		type: "text", style: "width: 30%; display: inline-block; text-align: center;", name: "party-name"
	});
	$( partyNameInput ).autocomplete({
		minLength: 0,
		delay: 0,
		source: function(request, response){
			var matches = [];
			for (let player of Data.Users){
				for (let party of player.parties){
					if (party.name.includes(request.term)){
						matches.push(party);
					}
				}
			}
			for (let party of LocalData.BattleParties){
				if (party.name.includes(request.term)){
					matches.push(party);
				}
			}
			response(matches);
		},
		select: function(event, ui){
			var partyNode = $$$(this).parent("party").node;
			write(partyNode, ui.item);
			comply(partyNode, {battleMode: $("#battleMode").val()});
			formatting(partyNode);
			relabel();
		}
	});
	partyNameInput.comply = function(kwargs){
		if (kwargs.battleMode == "raid"){
			var playerNode = $$$(this).parent("player");
			if (playerNode.child("player-team").val() == "1"){
				let pokemonNodes = $$$(this).parent("party").child("party-pokemon").node;
				while (pokemonNodes.children.length > 1){
					pokemonNodes.removeChild(pokemonNodes.lastChild);
				}
			}
		}
	}
	partyNameInput.onfocus = function(){
		$(this).autocomplete("search", "");
	}
	return partyNameInput;
}


function createSavePartyButton(){
	var savePartyButton = createElement('button','&lt;i class="fa fa-floppy-o" aria-hidden="true">&lt;/i>',{
		class: 'button-icon', title: 'Save'
	});
	savePartyButton.onclick = function(){
		var partyNode = $$$(this).parent("party").node;
		var partyName = $$$(partyNode).child("party-name").val();
		if (partyName.length > 0){
			let partyConfig = read(partyNode);
			party.label = partyName;
			insertEntry(party, LocalData.BattleParties);
			saveLocalData();
			sendFeedbackDialog('Local party "' + partyName + '" has been saved!');
		}
	}
	return savePartyButton;
}


function createRemovePartyButton(){
	var removePartyButton = createElement('button', '&lt;i class="fa fa-times" aria-hidden="true">&lt;/i>', {
		class: 'button-icon', title: 'Remove'
	});
	removePartyButton.onclick = function(){
		var partyNode = $$$(this).parent("party").node;
		var partyName = $$$(partyNode).child("party-name").val();
		var askForConfirm = getEntryIndex(partyName, LocalData.BattleParties) >= 0;
		if (partyNode.parentNode.children.length > 1){
			partyNode.parentNode.removeChild(partyNode);
		}else if (!askForConfirm){
			sendFeedbackDialog("Cannot remove the only party of the player.");
		}
		if (askForConfirm){
			var removePartyDialog = createElement('div', 'Do you want to remove local party "' + partyName + '"?');
			$(removePartyDialog).dialog({
				buttons: [{
					text: "Yes",
					style: 'width: 40%; float: left;',
					click: function() {
						removeEntry(partyName, LocalData.BattleParties);
						saveLocalData();
						$(this).dialog("close");
						sendFeedbackDialog('Local party "' + partyName + '" has been removed.');
					}
				},{
					text: "No",
					style: 'width: 40%; float: right;',
					click: function(){
						$(this).dialog("close");
					}
				}]
			}).dialog('open');
		}
		relabel();
	}
	return removePartyButton;
}


function createPartyReviveCheckbox(){
	var reviveCheckboxContainer = createElement("label", "Max Revive", {style: "width: 50%"});
	var reviveCheckbox = createElement("input", "", {type: "checkbox", name: "party-revive"});
	reviveCheckbox.onclick = function(){
		$(this).button("refresh");
	}
	reviveCheckbox.comply = function(kwargs){
		$(this).button("enable");
		if (kwargs.battleMode == "raid"){
			if ($$$(this).parent("player").child("player-team").val() == "1"){
				this.checked = false;
				$(this).button("refresh");
				$(this).button("disable");
			}
		}else if (kwargs.battleMode == "gym" || kwargs.battleMode == "pvp"){
			this.checked = false;
			$(this).button("refresh");
			$(this).button("disable");
		}
	}
	reviveCheckboxContainer.appendChild(reviveCheckbox);
	return reviveCheckboxContainer;
}


function createAddPokemonButton(){
	var addPokemonButton = createElement("button", "Add Pokemon", {style: "width: 50%"});
	addPokemonButton.onclick = function(){
		let partyNode = $$$(this).parent("party").node;
		let pokemonCount = countPokemonFromParty(partyNode);
		if (pokemonCount &lt; MAX_NUM_POKEMON_PER_PARTY){
			let newPokemonNode = createPokemonNode();
			let prevPokemonConfig = read(partyNode.children[1].lastChild);
			prevPokemonConfig.copies = 1;
			partyNode.children[1].appendChild(newPokemonNode);
			write(newPokemonNode, prevPokemonConfig);
			formatting(newPokemonNode);
			comply(newPokemonNode, {battleMode: $("#battleMode").val()});
			relabel();
		}else{
			sendFeedbackDialog("Exceeding Maximum number of Pokemon per party.");
		}
	}
	addPokemonButton.comply = function(kwargs){
		$(this).button("enable");
		if (kwargs.battleMode == "raid"){
			if ($$$(this).parent("player").child("player-team").val() == "1"){
				$(this).button("disable");
			}
		}
	}
	return addPokemonButton;
}


function createPlayerTeamInput(){
	var playerTeamInput = createElement('select', '', {
		style: 'width: 50%; display: inline-block; text-align: center;', name: "player-team"
	});
	playerTeamInput.appendChild(createElement('option', "Primary Team", {value: "0"}));
	playerTeamInput.appendChild(createElement('option', "Opposite Team", {value: "1"}));
	playerTeamInput.onchange = function(){
		/* TODO: Validation - different team
		// Something buggy on this section of codes
		var different = false;
		for (let player of read().players){
			if (player.team != this.value){
				different = true;
				break;
			}
		}
		if (!different){
			this.value = this.value == "0" ? "1": "0";
			sendFeedbackDialog("There must be two different teams");
		}
		*/
	}
	playerTeamInput.comply = function(kwargs){
		this.disabled = false;
		if (kwargs.battleMode == "raid" || kwargs.battleMode == "gym"){
			this.disabled = true;
			var playerNode = $$$(this).parent("player");
			if (playerNode.child("player-team").val() == "1" || kwargs.battleMode == "gym"){
				let partyNodes = playerNode.child("player-parties").node;
				while (partyNodes.children.length > 1){
					partyNodes.removeChild(partyNodes.lastChild);
				}
			}
		}
	}
	return playerTeamInput;
}


function createPlayerFriendInput(){
	var playerFriendInput = createElement('select', '', {
		style: 'width: 50%; display: inline-block; text-align: center;', name: "player-friend"
	});
	for (let friendSetting of Data.FriendSettings){
		playerFriendInput.appendChild(createElement('option', friendSetting.label, {value: friendSetting.name}));
	}
	playerFriendInput.comply = function(kwargs){
		this.disabled = false;
		if (kwargs.battleMode == "raid" || kwargs.battleMode == "gym"){
			if ($$$(this).parent("player").child("player-team").val() == "1"){
				this.value = "none";
				this.disabled = true;
			}
		}
	}
	return playerFriendInput;
}


function createRemovePlayerButton(){
	var removePlayerButton = createElement('button','&lt;i class="fa fa-times" aria-hidden="true">&lt;/i>',{
		class: 'button-icon', title: 'Remove'
	});
	removePlayerButton.onclick = function(){
		var playersNode = $$$(document.getElementById("input")).child("input-players").node;
		if (playersNode.children.length > 2){
			var playerNode = $$$(this).parent("player").node;
			playerNode.parentNode.removeChild(playerNode);
			document.getElementById('input.addPlayer').disabled = false;
			relabel();
		}else{
			sendFeedbackDialog("Need at least two players to fight");
		}
	}
	return removePlayerButton;
}


function createAddPartyButton(){
	var addPartyButton = createElement("button", "Add Party", {
		class: 'player_button'
	});
	addPartyButton.onclick = function(){
		var playerNode = $$$(this).parent("player").node;
		if (playerNode.children[1].children.length &lt; MAX_NUM_PARTIES_PER_PLAYER){
			playerNode.children[1].appendChild(createPartyNode());
			relabel();
		}else{
			sendFeedbackDialog("Exceeding Maximum number of Parties per player.");
		}
	}
	addPartyButton.comply = function(kwargs){
		$(this).button("enable");
		if (kwargs.battleMode == "raid"){
			if ($$$(this).parent("player").child("player-team").val() == "1"){
				$(this).button("disable");
			}
		}else if (kwargs.battleMode == "gym"){
			$(this).button("disable");
		}
	}
	return addPartyButton;
}

// Recursive call to make a node and all its children to comply the system requirements
function comply(node, kwargs){
	node = node || document.getElementById("input");
	kwargs = kwargs || {battleMode: $("#battleMode").val()};
	if (node.comply){
		node.comply(kwargs);
	}
	for (let child of node.children){
		comply(child, kwargs);
	}
}

// Trigger when the battle mode input changed
function complyBattleMode(mode){
	let playerNodes = $$$(document.getElementById("input")).child("input-players").node;
	if (mode == "gym" || mode == "raid"){
		let hasProcessedDefender = false;
		for (let playerNode of playerNodes.children){
			if ($$$(playerNode).child("player-team").val() == "1"){
				if (hasProcessedDefender){
					playerNodes.removeChild(playerNode);
				}else{
					hasProcessedDefender = true;
				}
			}
		}
	}else if (mode == "pvp"){
		
	}
	comply(playerNodes, {battleMode: mode});
	var timelimitInput = document.getElementById("timelimit");
	if (mode == "gym"){
		timelimitInput.value = Data.BattleSettings.timelimitGymMs;
	}else if (mode == "pvp"){
		timelimitInput.value = Data.BattleSettings.timelimitPvPMs;
	}
}


function createPokemonNode(){
	var pokemonNode = createElement('div', '', {
		class: "section-body section-pokemon-node", name: "pokemon"
	});
	pokemonNode.appendChild(createElement('div', "", {class: "section-node-head"}));
	pokemonNode.appendChild(createElement('div', ""));
	pokemonNode.appendChild(createElement('div', ""));
	
	// 1. Head
	pokemonNode.children[0].appendChild(createElement('span', "Unlabeled Pokemon", {class: "section-node-title"}));
	
	var controlButtonDiv = createElement('div', "", {class: "section-buttons-panel"});
	controlButtonDiv.appendChild(createMinimizeButton("pokemon"));
	controlButtonDiv.appendChild(createCopyPokemonButton());
	controlButtonDiv.appendChild(createPastePokemonButton());
	controlButtonDiv.appendChild(createRemovePokemonButton());
	pokemonNode.children[0].appendChild(controlButtonDiv);
	
	
	// 2. Body
	var tb1 = createElement("table", "&lt;colgroup>&lt;col width=50%>&lt;col width=25%>&lt;col width=25%>&lt;/colgroup>");
	tb1.appendChild(createRow(['', '', ''], 'td'));
	tb1.children[1].children[0].appendChild(createPokemonNameInput());
	tb1.children[1].children[0].appendChild(createElement("input", "", {name: "pokemon-label", hidden: true}));
	tb1.children[1].children[1].appendChild(createPokemonRoleInput());
	tb1.children[1].children[2].appendChild(createPokemonCopiesInput());
	pokemonNode.children[1].appendChild(tb1);
	
	var tb2 = createElement("table", "&lt;colgroup>&lt;col width=25%>&lt;col width=25%>&lt;col width=25%>&lt;col width=25%>&lt;/colgroup>", {for_roles: "a;gd"});
	tb2.appendChild(createRow(['', '', '', ''], 'td'));
	tb2.children[1].children[0].appendChild(createElement("input", "", {
		placeholder: "Level", name: "pokemon-level"
	}));
	tb2.children[1].children[1].appendChild(createElement("input", "", {
		placeholder: "HP IV", name: "pokemon-stmiv"
	}));
	tb2.children[1].children[2].appendChild(createElement("input", "", {
		placeholder: "Atk. IV", name: "pokemon-atkiv"
	}));
	tb2.children[1].children[3].appendChild(createElement("input", "", {
		placeholder: "Def. IV", name: "pokemon-defiv"
	}));
	pokemonNode.children[1].appendChild(tb2);
	
	var tb2b = createElement("table", "&lt;colgroup>&lt;col width=100%>&lt;/colgroup>", {hidden: "true", for_roles: "a_basic;gd_basic"});
	tb2b.appendChild(createRow(['']));
	tb2b.children[1].children[0].appendChild(createElement("input", "", {
		placeholder: "CP", name: "pokemon-cp"
	}));
	pokemonNode.children[1].appendChild(tb2b);
	
	var tb3 = createElement("table", "&lt;colgroup>&lt;col width=100%>&lt;/colgroup>", {hidden: "true", for_roles: "rb;RB"});
	tb3.appendChild(createRow(['']));
	tb3.children[1].children[0].appendChild(createPokemonRaidTierInput());
	pokemonNode.children[1].appendChild(tb3);

	var tb4 = createElement("table", "&lt;colgroup>&lt;col width=50%>&lt;col width=50%>&lt;/colgroup>");
	tb4.appendChild(createRow(['', ''], 'td'));
	tb4.children[1].children[0].appendChild(createPokemonMoveInput("fast", "fmove"));
	tb4.children[1].children[1].appendChild(createPokemonStrategyInput());
	var protectShieldStratInput = createPokemonProtectStrategyInput();
	protectShieldStratInput.setAttribute("hidden", true);
	tb4.children[1].children[1].appendChild(protectShieldStratInput);
	pokemonNode.children[1].appendChild(tb4);
	
	var tb5 = createElement("table", "&lt;colgroup>&lt;col width=50%>&lt;col width=50%>&lt;/colgroup>");
	tb5.appendChild(createRow(['', ''], 'td'));
	tb5.children[1].children[0].appendChild(createPokemonMoveInput("charged", "cmove"));
	tb5.children[1].children[1].appendChild(createPokemonMoveInput("charged", "cmove2"));
	pokemonNode.children[1].appendChild(tb5);
	
	return pokemonNode;
}


function createPartyNode(){
	var partyNode = createElement('div', '', {
		class: 'section-body section-party-node', name: "party"
	});
	partyNode.appendChild(createElement('div', "", {class: "section-node-head"}));
	partyNode.appendChild(createElement('div', "", {name: "party-pokemon"}));
	partyNode.appendChild(createElement('div', "", {style: "width:100%"}));
	
	// 1. Head
	partyNode.children[0].innerHTML = "&lt;span class='section-node-title'>Unlabeled Party&lt;/span>";
	partyNode.children[0].appendChild(createPartyNameInput());
	var controlButtonDiv = createElement('div', "", {class: "section-buttons-panel"});
	controlButtonDiv.appendChild(createMinimizeButton("party"));
	controlButtonDiv.appendChild(createSavePartyButton());
	controlButtonDiv.appendChild(createRemovePartyButton());
	partyNode.children[0].appendChild(controlButtonDiv);
	
	// 2. Body
	partyNode.children[1].appendChild(createPokemonNode());
	$( partyNode.children[1] ).sortable({axis: 'y'});
	
	// 3. Tail
	partyNode.children[2].appendChild(createPartyReviveCheckbox());
	partyNode.children[2].appendChild(createAddPokemonButton());
	$( partyNode.children[2] ).controlgroup();
	
	return partyNode;
}


function createPlayerNode(){
	var playerNode = createElement('div', '', {
		class: 'section-body section-player-node', name: "player"
	});
	playerNode.appendChild(createElement('div', "", {class: "section-node-head"}));
	playerNode.appendChild(createElement('div', "", {name: "player-parties"}));
	playerNode.appendChild(createElement('div', "", {style: "width:100%"}));
	
	// 1. Head
	playerNode.children[0].innerHTML = "&lt;span class='section-node-title'>Unlabeled Player&lt;/span>";
	var playerSettingDiv = createElement('div','', {
		style: 'width: 50%; display: inline-block; text-align: center;'
	});
	playerSettingDiv.appendChild(createPlayerTeamInput());
	playerSettingDiv.appendChild(createPlayerFriendInput());
	playerNode.children[0].appendChild(playerSettingDiv);
	
	var controlButtonDiv = createElement('div', "", {class: 'section-buttons-panel'});
	controlButtonDiv.appendChild(createMinimizeButton("player"));
	controlButtonDiv.appendChild(createRemovePlayerButton());
	playerNode.children[0].appendChild(controlButtonDiv);
	
	// 2. Body
	playerNode.children[1].appendChild(createPartyNode());
	$( playerNode.children[1] ).sortable({axis: 'y'});
	
	// 3. Tail
	playerNode.children[2].appendChild(createAddPartyButton());
	$( playerNode.children[2] ).controlgroup();
	
	return playerNode;
}


function addPlayerNode(){
	var playerNodes = $$$(document.getElementById("input")).child("input-players").node;
	if (playerNodes.children.length &lt; MAX_NUM_OF_PLAYERS){
		playerNodes.appendChild(createPlayerNode());
		relabel();
	}else{
		document.getElementById('input.addPlayer').setAttribute('disabled', true);
		sendFeedbackDialog('Exceeding maximum number of players.');
	}
}

// Update label and background color of player/party/pokemon nodes based on their position
function relabel(){
	var playerNodes = $$$(document.getElementById("input")).child("input-players").node;
	let i = 0;
	for (let playerNode of playerNodes.children){
		playerNode.setAttribute('style', 'background:' + HSL_COLORS[i%HSL_COLORS.length][0]);
		playerNode.children[0].children[0].innerHTML = "Player " + (i+1);
		let j = 0;
		for (let partyNode of playerNode.children[1].children){
			partyNode.setAttribute('style', 'background:' + HSL_COLORS[i%HSL_COLORS.length][1]);
			partyNode.children[0].children[0].innerHTML = "Party " + (++j);
			let k = 0;
			for (let pokemonNode of partyNode.children[1].children){
				pokemonNode.setAttribute('style', 'background:' + HSL_COLORS[i%HSL_COLORS.length][2]);
				pokemonNode.children[0].children[0].innerHTML = "Pokemon " + (++k);
			}
		}
		i++;
	}
}


function countPokemonFromParty(partyNode){
	var count = 0;
	for (let pokemonNode of partyNode.children[1].children){
		count += parseInt($$$(pokemonNode).child("pokemon-copies").val()) || 0;
	}
	return count;
}


function clearAllSims(){
	currentJobSize = 0;
	MasterSummaryTableMetrics = JSON.parse(JSON.stringify(DEFAULT_SUMMARY_TABLE_METRICS));
	sendFeedback("");
	Simulations = [];
	window.history.pushState('', "GoBattleSim", window.location.href.split('?')[0]);
	updateMasterSummaryTable();
	document.getElementById("feedback_table2").innerHTML = "";
	document.getElementById("feedback_table3").innerHTML = "";
}


function createMasterSummaryTable(){
	var table = createElement('table', '&lt;thead>&lt;/thead>&lt;tfoot>&lt;/tfoot>&lt;tbody>&lt;/tbody>', {
		width: '100%', id: 'ui-mastersummarytable', cellspacing: '0', class: 'display nowrap'
	});
	var headers = ['#'];
	for (var m in MasterSummaryTableMetrics){
		headers.push(MasterSummaryTableMetrics[m]);
	}
	headers.push('Detail');
	table.children[0].appendChild(createRow(headers, "th"));
	table.children[1].appendChild(createRow(headers, "th"));
	for (var i = 0; i &lt; Simulations.length; i++){
		let sim = Simulations[i];
		var rowData = [i+1];
		for (var metric in MasterSummaryTableMetrics){
			if (metric[0] == '*'){
				metric = metric.slice(1);
				var pkmInfo = getPokemonConfig(sim.input, metric.split('.')[0]);
				var attr = metric.split('.')[1];
				if (attr == 'name'){
					let pkmData = getEntry(pkmInfo.name, Data.Pokemon) || {};
					rowData.push(createIconLabelSpan(pkmData.icon, pkmInfo.label || pkmData.label, 'species-input-with-icon'));
				}else if (attr == 'fmove' || attr == 'cmove' || attr == 'cmove2'){
					try{
						var move = new Move(pkmInfo[attr]);
					}catch(err){
						var move = {};
					}					
					rowData.push(createIconLabelSpan(move.icon, move.label, 'move-input-with-icon'));
				}else{
					rowData.push(pkmInfo[attr]);
				}
			}else if (metric == 'weather'){
				rowData.push(sim.input.weather);
			}else{
				let cellData = sim.output.statistics[metric];
				if (typeof cellData == typeof 0){
					if (metric == "outcome"){
						if (sim.input.aggregation == "enum"){
							rowData.push(cellData == 1 ? "Win" : "Lose");
						}else{
							rowData.push(round(cellData * 100, 2) + "%");
						}
					}else{
						rowData.push(round(cellData, 2));
					}
				}else{
					rowData.push(cellData);
				}
			}
		}
		rowData.push("&lt;a style='cursor: pointer'>&lt;i class='fa fa-info-circle' aria-hidden='true'>&lt;/i>&lt;/a>");
		var rowEl = createRow(rowData, "td");
		rowEl.lastChild.onclick = function(){
			updateSimulationDetails(sim);
			document.getElementById('feedback_table2').scrollIntoView({behavior: "smooth", block: "center", inline: "center"});
		}
		table.children[2].appendChild(rowEl);
	}
	return table;
}


function createPlayerStatisticsString(playerStat){
	var pString = playerStat.name;
	pString += ", TDO: " + round(playerStat.tdo, 2);
	pString += ", DPS: " + round(playerStat.dps, 2);
	return pString;
}


function createPokemonStatisticsTable(pokemonStatistics){
	var table = document.createElement("table");
	table.appendChild(createRow(["&lt;img src='" + getPokemonIcon({dex: 0}) + "'>&lt;/img>",
								"HP", "Energy", "TDO", "Duration", "DPS", "Detail"], 'th'));
	for (var i = 0; i &lt; pokemonStatistics.length; i++){
		let statistics = pokemonStatistics[i];
		let row = createRow([
			"&lt;img src='" + getPokemonIcon({name: statistics.name}) + "' class='apitem-pokemon-icon'>&lt;/img>", 
			statistics.hp, statistics.energy, statistics.tdo, round(statistics.duration, 2), round(statistics.dps, 2), 
			"&lt;a style='cursor: pointer'>&lt;i class='fa fa-info-circle' aria-hidden='true'>&lt;/i>&lt;/a>"
		], 'td');
		row.lastChild.children[0].onclick = function(){
			var pokemonDialog = createElement('div', '', {title: 'Pokemon Detail'});
			var pokemonTable = createElement('table', '');
			for (var attr in statistics){
				pokemonTable.appendChild(createElement('tr',"&lt;th>" + attr + "&lt;/th>&lt;td>" + statistics[attr] + "&lt;/td>"));
			}
			pokemonDialog.appendChild(pokemonTable);
			$(pokemonDialog).dialog({
				width: 400,
				position: { my: "center", at: "center", 'of': row }
			}).dialog('open');
		};
		table.appendChild(row);
	}
	return table;
}


function updateMasterSummaryTable(){
	document.getElementById("feedback_table1").innerHTML = "";
	var table = createMasterSummaryTable();
	document.getElementById("feedback_table1").appendChild(table);
	var dt = $( table ).DataTable({
		scroller: true,
        scrollX: true,
		scrollY: '30vh'
	});
	addFilterToFooter(dt);
	document.getElementById("copy-button-clipboard").setAttribute("onclick", "");
	document.getElementById("copy-button-csv").setAttribute("onclick", "");
}


function updateSimulationDetails(sim){
	// Replay the input
	var inputEl = document.getElementById("input");
	write(inputEl, sim.input);
	complyBattleMode(sim.input.battleMode);
	formatting(inputEl);
	relabel();
	window.history.pushState('', "GoBattleSim", window.location.href.split('?')[0] + '?' + exportConfig(sim.input));
	
	// Update Player/Party/Pokemon statistics
	var section = document.getElementById("feedback_table2");
	section.innerHTML = "";
	for (var i = 0; i &lt; sim.output.statistics.players.length; i++){
		var playerStat = sim.output.statistics.players[i];
		section.appendChild(createElement('h4', createPlayerStatisticsString(playerStat), 
			{style: 'background:' + HSL_COLORS[i%HSL_COLORS.length][0]}));
		var playerDiv = document.createElement('div');
		for (var j = 0; j &lt; playerStat.parties.length; j++){
			playerDiv.appendChild(createElement('h5', 'Party ' + (j+1)));
			var partyDiv = document.createElement('div');
			partyDiv.appendChild(createPokemonStatisticsTable(playerStat.parties[j].pokemon));
			playerDiv.appendChild(partyDiv);
		}
		section.appendChild(playerDiv);
		$( playerDiv ).accordion({
			active: false,
			collapsible: true,
			heightStyle: 'content'
		});
	}
	$( section ).accordion({
		active: false,
		collapsible: true,
		heightStyle: 'content'
	});
	
	// Battle Log
	var section = document.getElementById("feedback_table3");
	section.innerHTML = "";
	if (sim.output.battleLog.length > 0){
		section.appendChild(createBattleLogTable(sim.output.battleLog));
	}
}


function createBattleLogTable(log){
	var table = createElement('table', '&lt;thead>&lt;/thead>', {
		width: '100%', class: 'display nowrap', id: "ui-log-table"
	});
	let headers = ["Time"];
	for (let i = 0; i &lt; log[0].events.length; i++){
		headers.push("Player " + (i+1));
	}
	table.children[0].appendChild(createRow(headers, "th"));
	var tbody = createElement("tbody");
	for (let i = 0; i &lt; log.length; i++){
		let entry = log[i];
		let tableRow = createElement("tr");
		tableRow.appendChild(createElement("td", round(entry.t/1000, 2)));
		for (let j = 0; j &lt; entry.events.length; j++){
			let tableCell = createElement("td");
			let singleEvent = entry.events[j] || {index: 0, options: [{text: ""}]};
			if (singleEvent.options.length > 1){
				let selectElement = createElement("select");
				for (let k = 0; k &lt; singleEvent.options.length; k++){
					let option = singleEvent.options[k];
					let optionEl = createElement("option", option.text);
					optionEl.value = k;
					if (option.style == "pokemon"){
						optionEl.dataset.class = "input-with-icon species-input-with-icon";
						optionEl.dataset.style = "background-image: url(" + option.icon + ");"
					}else if (option.style == "move"){
						optionEl.dataset.class = "input-with-icon move-input-with-icon";
						optionEl.dataset.style = "background-image: url(" + option.icon + ");"
					}
					selectElement.appendChild(optionEl);
				}
				selectElement.value = singleEvent.index;
				tableCell.appendChild(selectElement);
				$(selectElement).iconselectmenu({
					change: function(event, ui){
						singleEvent.index = ui.item.index;
						entry.breakpoint = true;
						var cfg = read();
						var battle = new Battle(cfg);
						battle.loadList(log);
						battle.resume();
						updateSimulationDetails({
							input: cfg,
							output: battle.getBattleResult()
						});
					}
				}).iconselectmenu("menuWidget").addClass("ui-menu-icons");
			} else {
				let curOption = singleEvent.options[singleEvent.index];
				if (curOption.style == "pokemon"){
					tableCell.innerHTML = createIconLabelSpan(curOption.icon, curOption.text, "species-input-with-icon");
				}else if (curOption.style == "move"){
					tableCell.innerHTML = createIconLabelSpan(curOption.icon, curOption.text, "move-input-with-icon");
				}else{
					tableCell.innerHTML = curOption.text;
				}
			}
			tableCell.setAttribute('style', 'background:' + HSL_COLORS[j % HSL_COLORS.length][0]);
			tableRow.appendChild(tableCell);
		}
		tbody.appendChild(tableRow);
	}
	table.appendChild(tbody);
	return table;
}

// Return the encoded URL based on simulation configuration
function exportConfig(cfg){
	// Delete redundant attributes to shorten the URL
	let cfg_min = JSON.parse(JSON.stringify(cfg));
	for (let player of cfg_min.players){
		for (var attr in player){
			if (!player[attr]){
				delete player[attr];
			}
		}
		for (let party of player.parties){
			for (var attr in party){
				if (!party[attr]){
					delete party[attr];
				}
			}
			for (let pokemon of party.pokemon){
				delete pokemon.label;
				for (var attr in pokemon){
					if (!pokemon[attr]){
						delete pokemon[attr];
					}
					if ((pokemon.role || "").toLowerCase() == "rb"){
						delete pokemon.atkiv;
						delete pokemon.defiv;
						delete pokemon.stmiv;
						delete pokemon.level;
					}else{
						delete pokemon.raidTier;
					}
				}
			}
		}
	}
	return jsonToURI(cfg_min);
}

// Return simulation configuration parsed from URL
function importConfig(url){
	var cfg = uriToJSON(url.split('?')[1]);
	if (cfg.hasOwnProperty("atkrSettings")){ // Backward compatibility to v2
		cfg.players = [];
		for (let player of cfg.atkrSettings){
			player.team = "0";
			player.parties = player.party_list;
			delete player.party_list;
			for (let party of player.parties){
				party.revive = party.revive_strategy;
				party.pokemon = party.pokemon_list;
				delete party.revive_strategy;
				delete party.pokemon_list;
				for (let pokemon of party.pokemon){
					pokemon.role = "a";
					pokemon.strategy = (pokemon.dodge == "2" ? "strat3" : (pokemon.dodge == "1" ? "strat2" : "strat1"));
					delete pokemon.dodge;
				}
			}
			cfg.players.push(player);
		}
		delete cfg.atkrSettings;
		
		var defenderPokemon = cfg.dfdrSettings;
		defenderPokemon.copies = 1;
		defenderPokemon.strategy = "strat0";
		defenderPokemon.raidTier = parseInt(defenderPokemon.raid_tier);
		delete defenderPokemon.raid_tier;
		cfg.players.push({
			team: "1",
			friend: "none",
			parties: [
				{
					revive: false,
					pokemon: [defenderPokemon]
				}
			]
		});
		delete cfg.dfdrSettings;
		
		for (var attr in cfg.generalSettings){
			cfg[attr] = cfg.generalSettings[attr];
		}		
		if (cfg.battleMode == "raid" || defenderPokemon.raidTier > 0){
			cfg.battleMode = "raid";
			if (defenderPokemon.raidTier > 4){
				cfg.timelimit = Data.BattleSettings.timelimitLegendaryRaidMs;
			}else{
				cfg.timelimit = Data.BattleSettings.timelimitRaidMs;
			}
		}else{
			cfg.battleMode = "gym";
			cfg.timelimit = Data.BattleSettings.timelimitGymMs;
		}
		delete cfg.generalSettings;
	}
	return cfg;
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Battle.html">Battle</a></li><li><a href="GoBattleSimNode.html">GoBattleSimNode</a></li><li><a href="Move.html">Move</a></li><li><a href="Party.html">Party</a></li><li><a href="Player.html">Player</a></li><li><a href="Pokemon.html">Pokemon</a></li><li><a href="Strategy.html">Strategy</a></li><li><a href="Timeline.html">Timeline</a></li></ul><h3>Global</h3><ul><li><a href="global.html#$$$">$$$</a></li><li><a href="global.html#assignMoveParameterSet">assignMoveParameterSet</a></li><li><a href="global.html#binarySearch">binarySearch</a></li><li><a href="global.html#calculateCP">calculateCP</a></li><li><a href="global.html#Combination">Combination</a></li><li><a href="global.html#createElement">createElement</a></li><li><a href="global.html#damage">damage</a></li><li><a href="global.html#Data">Data</a></li><li><a href="global.html#fetchAll">fetchAll</a></li><li><a href="global.html#fetchAll_then">fetchAll_then</a></li><li><a href="global.html#fetchLevelData">fetchLevelData</a></li><li><a href="global.html#fetchLocalData">fetchLocalData</a></li><li><a href="global.html#fetchMoveData">fetchMoveData</a></li><li><a href="global.html#fetchRaidBossList">fetchRaidBossList</a></li><li><a href="global.html#fetchSpeciesData">fetchSpeciesData</a></li><li><a href="global.html#fetchSpeciesFormData">fetchSpeciesFormData</a></li><li><a href="global.html#fetchUserData">fetchUserData</a></li><li><a href="global.html#fetchUserTeamData">fetchUserTeamData</a></li><li><a href="global.html#getEntry">getEntry</a></li><li><a href="global.html#getEntryIndex">getEntryIndex</a></li><li><a href="global.html#getFriendMultiplier">getFriendMultiplier</a></li><li><a href="global.html#getPokemonIcon">getPokemonIcon</a></li><li><a href="global.html#getTypeIcon">getTypeIcon</a></li><li><a href="global.html#handleSpeciesDatabase">handleSpeciesDatabase</a></li><li><a href="global.html#inferLevelAndIVs">inferLevelAndIVs</a></li><li><a href="global.html#insertEntry">insertEntry</a></li><li><a href="global.html#LocalData">LocalData</a></li><li><a href="global.html#mergeDatabase">mergeDatabase</a></li><li><a href="global.html#parseMovesFromString">parseMovesFromString</a></li><li><a href="global.html#parsePokemonTypeFromString">parsePokemonTypeFromString</a></li><li><a href="global.html#parseUserPokebox">parseUserPokebox</a></li><li><a href="global.html#Permutation">Permutation</a></li><li><a href="global.html#populateAll">populateAll</a></li><li><a href="global.html#removeEntry">removeEntry</a></li><li><a href="global.html#round">round</a></li><li><a href="global.html#saveLocalData">saveLocalData</a></li><li><a href="global.html#sortDatabase">sortDatabase</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Feb 20 2019 02:15:08 GMT+0800 (Hong Kong Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
